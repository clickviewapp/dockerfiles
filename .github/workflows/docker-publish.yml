name: Build & Publish Docker Images

on:
  push:
    branches: ["master"]

jobs:
  discover-dockerfiles:
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.extract.outputs.dockerfiles }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate matrix from manifest.yaml
        id: extract
        run: |
          files=()

          # Iterate all root keys
          roots=$(yq e -r 'keys | .[]' manifest.yaml)
          for root in $roots; do
            while read -r version; do
              echo "Found ${root} | ${version}"
              dockerfile="./${root}/${version}/Dockerfile"
              # Read image_name safely
              image_name=$(yq e -r ".${root}.versions.\"${version}\".image_name" manifest.yaml)
              echo "Image name: $image_name"
              if [ -n "$image_name" ] && [ "$image_name" != "null" ]; then
                files+=("$dockerfile|$image_name")
              fi
            done < <(yq e -r ".${root}.versions | keys | .[]" manifest.yaml)
          done

          # Convert array to JSON for matrix
          json=$(printf '%s\n' "${files[@]}" | jq -R . | jq -s .)
          echo "dockerfiles=$json" >> $GITHUB_OUTPUT

  build-and-push:
    needs: discover-dockerfiles
    runs-on: ubuntu-latest
    strategy:
      matrix:
        entry: ${{ fromJson(needs.discover-dockerfiles.outputs.dockerfiles) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Parse Dockerfile and image
        id: metadata
        run: |
          # Split matrix.entry into Dockerfile and image
          dockerfile="${{ matrix.entry }}"
          dockerfile="${dockerfile%%|*}"
          image="${{ matrix.entry }}"
          image="${image##*|}"
          dir=$(dirname "$dockerfile")
          short_sha="${GITHUB_SHA:0:7}"

          echo "directory=$dir" >> $GITHUB_OUTPUT
          echo "image=$image" >> $GITHUB_OUTPUT
          echo "short_sha=$short_sha" >> $GITHUB_OUTPUT

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ${{ steps.metadata.outputs.directory }}
          file: ${{ steps.metadata.outputs.directory }}/Dockerfile
          push: true
          tags: |
            ${{ steps.metadata.outputs.image }}:latest
            ${{ steps.metadata.outputs.image }}:${{ steps.metadata.outputs.short_sha }}
